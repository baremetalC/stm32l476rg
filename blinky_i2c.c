#include "stm32l4xx.h" 

#define WIDTH  128
#define HEIGHT  64
volatile uint8_t state;
volatile uint8_t input[2]; 

//the examples on the internet did not makes sense to me so I wrote my own hex codes (i must be missing something?)
//the bit is written 8 bytes veritically so basically the array must be 128*8 for the whole screen
const uint8_t ON [] = 
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0x00,0xaa,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0xaa,0x00,0xaa,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0xaa,0x00,0x00,0x00,0xaa,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0xaa,0x00,0xaa,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};


const uint8_t OFF [] = 
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0x00,0xaa,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0xaa,0x00,0xaa,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0xaa,0x00,0x00,0x00,0xaa,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0xaa,0x00,0xaa,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0xaa,0x00,0xaa,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};


void delay(){
	for(int i=0; i < 200000; i++){
	}
}

void Led_On(void){
	// Set the 5th bit (for set)
	GPIOA->BSRR = (1ul << 5);
	state = 1;
}

void Led_Off(void){
	// Set the 21st bit (for reset)
		GPIOA->BSRR = (1ul << 21);
		state = 0;
}
// the interrupt set by config_timer
void TIM6_DAC_IRQHandler(void){
	
	// Check if update interrupt pending flag is set
	if (TIM6->SR & (1ul)) // ((1ul)->TIM_SR_UIF)
	{
		// Set the flag off as the interrupt has been handled
		TIM6->SR &= ~(1ul);
		if (state == 0){
			Led_On();
		} else {
			Led_Off();
		}
	}
}


void Config_Timer(void){
	
	// Initialize clock for TIM6 set RCC_APB1ENR1_TIM6EN 
	RCC->APB1ENR1 |= (1ul << 4);
	
	// Setting Control register of timer
	// Enable bit 0 to enable counter TIM_CR1_CEN
	// Enable bit 2 to only send interrupt when overflow/underflow TIM_CR1_URS
	TIM6->CR1 |= ((1ul) | (1ul << 2));
	
	// Setting our prescaler value since clock speed is 4mhz  by default 4mhz/(61) ~= 1 event per sec (not very accurate?) 
	// Calculation is for uint16 bit counter ..counter value can be set by TIM6->ARR
	TIM6->PSC = (62-1);
	
	// Enable update interrupt set TIM_DIER_UIE
	TIM6->DIER |= (1ul);
	
	// Since NVIC handles all interrupts and exception...need to configure it
	// Function provided to set priority has inputs IRQn_Type IRQn, uint32_t priority
	// Priority of 0 is set whisch is the highest priority
	// IRQn_Type of TIM6_DAC_IRQn = 54 is set
	NVIC_SetPriority(TIM6_DAC_IRQn, 0);
	// Enable the interrupt request
	NVIC_EnableIRQ(TIM6_DAC_IRQn);
}

void writeData(uint8_t data){
	// Set the start generation I2C_CR2_START 
	I2C1->CR2 |= (1ul << 13);
	// address to write data
	I2C1->TXDR = 0x40;
	// Check transmit data register is empty
	while(!(I2C1->ISR & 1));
	I2C1->TXDR = data;
	while(!(I2C1->ISR & 1));
	//Set the stop bit I2C_CR2_STOP
	I2C2->CR2 |= (1 << 14);
}

void writeCommand(uint8_t command){	
	// Set the start generation I2C_CR2_START 
	I2C1->CR2 |= (1ul << 13);
	// address to write command
	I2C1->TXDR = 0x00;
	// Check transmit data register is empty
	while(!(I2C1->ISR & 1));
	I2C1->TXDR = command;
	while(!(I2C1->ISR & 1));
	//Set the stop bit I2C_CR2_STOP
	I2C2->CR2 |= (1 << 14);
}

void init_oled(void){
	delay();
	writeCommand(0xAE); //turn off oled panel
	writeCommand(0x00); // set low column address
	writeCommand(0x10); //set high column address
	writeCommand(0x40); //set start line
	writeCommand(0x81); //set contrast control register
	writeCommand(0xCF); //set output brightness
	writeCommand(0xA1); //set column mapping (0xa0(rev left and right) and 0xa1 (normal))
	writeCommand(0xC8); // set row scan direction )xc0 (upside down) and 0xc8 (normal)
	writeCommand(0xA6); // set normal display
	writeCommand(0xA8); // set multiplex ratio(1 to 64)
	writeCommand(0x3f); // 1/64 duty
	writeCommand(0xD3); // set display offset (0x00-ox3F)
	writeCommand(0x00); //no offset 
	writeCommand(0xD5); // set display clock divide ratio/oscillator frequency
	writeCommand(0x80); //set divide ratio, Set clock as 100 frame/sec
	writeCommand(0xD9); //set prep-charge period
	writeCommand(0xF1); // set precharge as 15 clcoks and discharge as 1 clock
	writeCommand(0xDA); // set comm pins hardware configuration
	writeCommand(0x12); 
	writeCommand(0xDB); //set vcomh
	writeCommand(0x20); // set VCOM deselect level
	writeCommand(0x20); // set page addressing mode (0x00,0x01,0x02)
	writeCommand(0x00);  //horizontal mode 01 is vertical and 02 is page
	writeCommand(0xA4); //display follow gdram content
	writeCommand(0x8D); //set charge pump enable/disable
	writeCommand(0x14); // enable pump
	writeCommand(0xAF); //turn on oled panel
}

void resetScreen(void){
//Clear Screen
	writeCommand(0x21); //Column address
	writeCommand(0); // column start address Reset = 0
	writeCommand(WIDTH - 1); //column end address Reset=127
	
	writeCommand(0x22); //Page address
	writeCommand(0); // reset
	writeCommand(7); //Page end address
}

void close_oled(void){
	delay();
	//Stop sequence
	writeCommand(0xAE); // turn off display
	writeCommand(0x8D);
	writeCommand(0x10); //disable pump
}

void Config_GPIOA(void){
	
	//Step 1: initialize gpio for led (set clock and modes)
	//Initializing clock for GPIO-A
	RCC->AHB2ENR |= 1ul;
	
	//(Here, 10=2*5(5th pin)...each pin has 2 bits)
	
	// Unsetting Mode at port GPIOA-5
	GPIOA->MODER &= ~(3ul << 10); // 
	// Setting Mode to output i.e, 01 
	//(00 is input(reset), 10 is alternate function, 11 is analog mode)
	GPIOA->MODER |= (1ul << 10);
	
	// Setting type of output i.e., 0 for push-pull, 1 would be open drain
	// Here 5 cuz only 1 bit
	GPIOA->OTYPER &= ~(1ul << 5);
	
	//Unsetting the speed of I/0
	GPIOA->OSPEEDR &= ~(3ul << 10);
	//Setting speed to medium i.e., 01 
	//(00 for low speed, 10 for fast speed, 11 for high speed)
	GPIOA->OSPEEDR |= (1ul << 10);
	
	//Unsetting the I/O pull up pull down
	//setting to 00 for no pull up pull down (01 for pull up, 10 for pull down, 11 for resrved)
	GPIOA->PUPDR &= ~(3ul << 10);
}


void Config_USART2(){
	//	GPIOA-2 PA-2 with AF7 is for tx of USART2->
	// Configure PA-3 for rx of USART2 set AF7
	// Set mode to alternate function
	GPIOA->MODER &= ~((3ul << 2*2) | (3ul << 2*3));
	GPIOA->MODER |= ((2ul << 2*2)|(2ul << 2*3));
	// Output to push pull
	GPIOA->OTYPER &= ~((1ul << 2)|(1ul << 3));
	// Since 4 bit configuation for AFR and pin is 2nd and set 7 for AF7
	GPIOA->AFR[0] &= ~((15ul << 4*2) | (15ul << 4*3));
	GPIOA->AFR[0] |= ((7ul << 4*2) |(7ul << 4*3));

	// set the timer for usart2 RCC_APB1ENR1_USART2EN
	RCC->APB1ENR1 |= (1ul << 17);
	
	USART2->BRR = SystemCoreClock/115200;
	//bit to transmit is 8 by default UARTx->CR1 to configure
	// Enable UART by setting 1st bit USART_CR1_UE
	// Enable the transmitter by setting the 3rd bit USART_CR1_TE
	// Enable the reciever by setting the 2nd bit USART_CR1_RE
	USART2->CR1 |= (1ul | 1ul << 3 | 1ul << 2);
}

// Check USART Input
void checkInput(){
	//checking for Reciever bit is not empty USART_ISR_RXNE
		while(!(USART2->ISR & 1 << 5));
		//recive the data and populate the array by shifting prev char by -1 position
		input[0] = input[1];
		input[1] =  USART2->RDR;
		while(!(USART2->ISR & 1 << 6));
		USART2->TDR = USART2->RDR;
	
	if (input[0] != 'o'){
		return;
	}
	if(input[1] == 'n'){
		Led_On();
		for (uint16_t i =0; i < sizeof(ON); i++){
			writeData(ON[i]);
		}
	}
	
	if (input[1] == 'f'){
		Led_Off();
		for (uint16_t i =0; i < sizeof(OFF); i++){
			writeData(OFF[i]);
	}
	}
}


int main(void){
	// Enable msi clock at 8mhz for sys clock (chose this because i2c had configuration of 8mhz timer in the reference manual)
	RCC->CR |= (1);
	while(!(RCC->CR & (1 << 1)));
	// set msi range from cr itself
	RCC->CR |= (1 << 3);
	// set msi frequency 8
	RCC->CR |= (7 << 4);
	//SEt msi as sysclcksrc
	RCC->CFGR &= ~(3);
	SystemCoreClockUpdate();
	
	Config_GPIOA();
	Config_USART2();


	//Configure I2C -> GPIOB port 9 for sda port 8 for scl
	RCC->AHB2ENR |= (1ul << 1);
	GPIOB->MODER &= ~((3ul << 2*9) | (3ul << 2*8));
	GPIOB->MODER |= ((2ul << 2*9)|(2ul << 2*8));
	// Set open drain mode
	GPIOB->OTYPER |= ((1ul << 9)|(1ul << 8));
	// Set pull up
	GPIOB->PUPDR &= ~((3ul << 2*9)| (3ul << 2*8));
	GPIOB->PUPDR |= ((1ul << 2*9)|(1ul << 2*8));
	// Set AF4 for I2C1 SDA AND SCL ports
	GPIOB->AFR[1] &= ~((15ul << 4*0) | (15ul << 4*1));
	GPIOB->AFR[1] |= ((4ul << 4*0) |(4ul << 4*1));
	
	// Clock for I2C1 RCC_APB1ENR1_I2C1EN
	RCC->APB1ENR1 |= (1ul << 21);
	
	//I2C initialization
	//Clear pe bit in i2c_Cr1 set dnf digital noise filter to off
	I2C1->CR1 &= ~(1ul);
	//set analog noise filter to on(not required)
//	I2C1->CR1 &= ~(1ul << 12);
	//set digital filter to on (not required)
//	I2C1->CR1 |= (15ul << 8);
	//config isc1->timngr (config taken from reference manual for 8mhz clock)
	I2C1->TIMINGR |= (0x13 | 0xF << 8 | 0x2 << 16 | 0x4 << 20 | 0x1 << 28);
	// configure nostretch i.e. stretching is off
//	I2C1->CR1 |= (1ul << 17);
	// Turn on the I2C1 perpheral I2C_CR1_PE
	I2C1->CR1 |= (1ul);
	
	//Initialization (In CR2)
	//-Addressing mode add10 or 7  (bit 11 to 0 for 7)
	//-transfer direction-rd_wrn (nit 10 to 0 for write)
	//-finally the start bit to generate start condition(this must be at the end)
	//  Can configure autoend by setting I2C_CR2_AUTOEND as well
	// Configure byte to transmit i.e. 1 at I2C_CR2_NBYTES_Pos
	// Set slave address  at I2C_CR2_SADD_POS (needs to be 7 bit, bit 0,8,9 are ignored)
	
	//address mode and write bit to 0
	I2C1->CR2 &= ~(3 << 11);
	// address of sd1306 oled display
  I2C1->CR2 |=  (1 << 16) | 0x78 ;
	
	init_oled();
	
	while(1){
		checkInput();
	}
	return 0;
}
